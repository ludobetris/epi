<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Shop des Habits et EPI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* Style global ‚Äì design moderne, √©pur√© et responsive */
    body {
      background-color: #f7f7f7;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 900px;
      margin: 80px auto 20px auto;
      background: #fff;
      padding: 20px 40px 40px 40px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      position: relative;
    }
    h1, h2, h3 {
      text-align: center;
      color: #333;
    }
    /* Centre le formulaire de connexion */
    #login-section {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-top: 50px;
    }
    #login-section input {
      width: 200px;
      padding: 8px;
      margin: 10px;
      font-size: 1em;
    }
    #login-section button {
      padding: 8px 16px;
      font-size: 1em;
      cursor: pointer;
      background: #007BFF;
      border: none;
      color: #fff;
      border-radius: 4px;
    }
    /* Bouton d√©connexion ‚Äì affich√© toujours au premier plan */
    #logoutBtn {
      position: absolute;
      top: 20px;
      left: 20px;
      padding: 6px 12px;
      font-size: 0.9em;
      background: #f44336;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      display: none;
      z-index: 2000;
    }
    /* Tableau des √©quipements */
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 15px 0;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
      font-size: 0.9em;
    }
    th {
      background-color: #f4f4f4;
    }
    .btn {
      padding: 10px 15px;
      border: none;
      background: #007BFF;
      color: #fff;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
    }
    .btn:hover {
      background: #0056b3;
    }
    .close-btn {
      background: #f44336;
      color: #fff;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
    }
    /* Styles pour les modales */
    .modal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      padding: 20px 30px;
      border: 1px solid #ddd;
      border-radius: 4px;
      z-index: 1000;
      max-height: 90%;
      overflow-y: auto;
      width: 90%;
      max-width: 500px;
      text-align: center;
    }
    .modal.active {
      display: block;
    }
    .modal h3 {
      margin-top: 0;
      font-size: 1.5em;
      margin-bottom: 20px;
    }
    .modal label {
      font-size: 1.2em;
      margin: 10px 0;
      display: block;
    }
    .modal input,
    .modal select,
    .modal textarea {
      font-size: 1.1em;
      padding: 10px;
      margin: 10px 0;
      width: 100%;
      box-sizing: border-box;
    }
    .modal button,
    .modal .btn,
    .modal .close-btn {
      font-size: 1.2em;
      padding: 12px 20px;
      margin: 10px;
    }
    /* Overlay pour modales */
    .overlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.3);
      z-index: 900;
    }
    .overlay.active {
      display: block;
    }
    /* Ic√¥ne du panier en haut √† droite ‚Äì sur fond rond bleu clair, fixe et masqu√©e sur la page de connexion */
    #cartIcon {
      position: fixed;
      top: 20px;
      right: 20px;
      width: 50px;
      height: 50px;
      background: #87CEFA;
      border-radius: 50%;
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 30px;
      cursor: pointer;
      z-index: 2000;
    }
    #cartIcon .badge {
      position: absolute;
      top: -8px;
      right: -8px;
      background: red;
      color: white;
      border-radius: 50%;
      padding: 2px 6px;
      font-size: 14px;
      display: none;
    }
    /* Spinner de chargement g√©n√©ral */
    #loadingSpinner {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1100;
    }
    .spinner {
      border: 8px solid #f3f3f3;
      border-top: 8px solid #007BFF;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    /* Spinner pour l'admin */
    #adminSpinner {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 2100;
    }
    /* Styles pour la boutique en ligne dans le modal Shop */
    #shopProductsContainer {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
    }
    .product-card {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 10px;
      margin: 10px;
      text-align: center;
      width: calc(50% - 40px);
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      display: inline-block;
      vertical-align: top;
      background: #fff;
    }
    .product-card img {
      width: 100%;
      height: auto;
      border-radius: 4px;
    }
    .product-card select {
      margin: 10px 0;
      padding: 6px;
      font-size: 1em;
    }
    @media (max-width: 600px) {
      .container {
        margin: 40px 10px;
        padding: 20px;
      }
      #cartIcon {
        font-size: 26px;
        top: 10px;
        right: 10px;
      }
      #logoutBtn {
        top: 10px;
        left: 10px;
        font-size: 1em;
      }
      .product-card {
        width: calc(100% - 40px);
      }
    }
    /* Section d'affichage du quota */
    #quotaInfo {
      margin: 15px 0;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background: #f9f9f9;
      font-size: 0.9em;
    }
  </style>
</head>
<body>
  <!-- Spinner de chargement g√©n√©ral -->
  <div id="loadingSpinner">
    <div class="spinner"></div>
  </div>
  
  <!-- Spinner de chargement pour l'admin -->
  <div id="adminSpinner">
    <div class="spinner"></div>
  </div>
  
  <!-- Overlay pour modales -->
  <div id="overlay" class="overlay"></div>
  
  <!-- Ic√¥ne du panier (fixe, masqu√©e sur la page de connexion) -->
  <div id="cartIcon">
    üõí<span class="badge" id="cartCount">0</span>
  </div>
  
  <!-- Bouton de d√©connexion -->
  <button id="logoutBtn">D√©connexion</button>
  
  <div class="container">
    <h1>Shop des Habits et EPI</h1>
    
    <!-- Section de connexion centr√©e -->
    <div id="login-section">
      <h2>Connexion Employ√©</h2>
      <input type="text" id="employeeId" placeholder="Entrez votre identifiant">
      <button id="loginBtn" class="btn">Se connecter</button>
      <div id="loginMessage" style="color: red;"></div>
    </div>
    
    <!-- Section principale apr√®s connexion -->
    <div id="main-section" style="display: none;">
      <h2>Bienvenue, <span id="employeeName"></span>!</h2>
      
      <!-- Affichage du quota (poss√©d√© / droit √†) -->
      <div id="quotaInfo"></div>
      
      <h3>Mes √©quipements (quota uniquement)</h3>
      <table id="equipmentTable">
        <thead>
          <tr>
            <th>√âquipement</th>
            <th>Taille</th>
            <th>Date</th>
            <th>Statut</th>
          </tr>
        </thead>
        <tbody>
          <!-- Rempli dynamiquement -->
        </tbody>
      </table>
      <div style="text-align: center;">
        <button id="openShopBtn" class="btn">Shop</button>
        <button id="openExchangeBtn" class="btn">Faire un √©change</button>
        <button id="openSurplusHistoryBtn" class="btn">Historique de surplus</button>
      </div>
      <!-- Interface Administrateur -->
      <div id="admin-section" style="display: none; margin-top: 30px; border-top: 1px solid #ddd; padding-top: 20px;">
        <h2>Interface Administrateur</h2>
        <h3>Modifier le quota d'un employ√©</h3>
        <label for="adminEmployeeId">Identifiant Employ√© :</label>
        <input type="text" id="adminEmployeeId" placeholder="Identifiant"><br>
        <label for="newQuota">Nouveau quota (format JSON) :</label><br>
        <textarea id="newQuota" rows="4" cols="50">
{
  "pantalon": 2,
  "polo": 3,
  "polaire": 1,
  "casque": 1,
  "veste": 1,
  "lunettes": 1,
  "chaussures": 1,
  "chapeau": 1,
  "adaptateur": 1,
  "habits_pluie": 1
}
        </textarea><br>
        <button id="updateQuotaBtn" class="btn">Mettre √† jour le quota</button>
        <div id="adminMessage" style="color: purple;"></div>
        <h3>Commandes en cours</h3>
        <table id="pendingOrdersTable">
          <thead>
            <tr>
              <th>Employ√©</th>
              <th>√âquipement</th>
              <th>Taille</th>
              <th>Date</th>
              <th>Type</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            <!-- Rempli dynamiquement -->
          </tbody>
        </table>
      </div>
    </div>
  </div>
  
  <!-- Popup : Shop ‚Äì Boutique en ligne avec cartes produits -->
  <div id="shopModal" class="modal">
    <h3>Shop</h3>
    <div id="shopProductsContainer"></div>
    <button id="closeShopModal" class="close-btn">Fermer</button>
  </div>
  
  <!-- Popup : √âchange -->
  <div id="exchangeModal" class="modal">
    <h3>Faire un √©change</h3>
    <label for="exchangeItemSelect">Choisissez l'article √† √©changer :</label>
    <select id="exchangeItemSelect"></select><br>
    <button id="addToExchangeCartBtn" class="btn">Ajouter au panier</button>
    <button id="closeExchangeModal" class="close-btn">Fermer</button>
  </div>
  
  <!-- Popup : Historique Surplus -->
  <div id="surplusHistoryModal" class="modal">
    <h3>Historique des commandes en surplus</h3>
    <table id="surplusHistoryTable">
      <thead>
        <tr>
          <th>√âquipement</th>
          <th>Taille</th>
          <th>Prix</th>
          <th>Date</th>
          <th>Statut</th>
        </tr>
      </thead>
      <tbody>
        <!-- Rempli dynamiquement -->
      </tbody>
    </table>
    <button id="closeSurplusHistoryModal" class="close-btn">Fermer</button>
  </div>
  
  <!-- Popup : Panier commun -->
  <div id="cartModal" class="modal">
    <h3>Votre Panier</h3>
    <table id="cartTable">
      <thead>
        <tr>
          <th>Mode</th>
          <th>√âquipement</th>
          <th>Taille</th>
          <th>Cat√©gorie</th>
          <th>Prix</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        <!-- Rempli dynamiquement -->
      </tbody>
    </table>
    <!-- La confirmation de d√©duction de salaire s'affichera uniquement pour une commande en surplus -->
    <div id="surplusConfirmationContainer" style="display: none; margin:10px 0;">
      <input type="checkbox" id="surplusConfirmCheckbox">
      <label for="surplusConfirmCheckbox">Je confirme ma commande suppl√©mentaire et accepte la d√©duction de salaires</label>
    </div>
    <button id="confirmCartBtn" class="btn">Confirmer</button>
    <button id="closeCartModal" class="close-btn">Fermer</button>
    <div id="cartMessage" style="color: green;"></div>
  </div>
  
  <script>
    /*******************************************************
     * INT√âGRATION GOOGLE SHEETS
     * Utilisation de JSONP pour le GET (pour contourner CORS)
     * et fetch avec mode "no-cors" pour le POST.
     *******************************************************/
    const SHEET_API_URL = "https://script.google.com/macros/s/AKfycbyNkJscWQhl9Ez6riGKem6jUvo7ZpIwlhbJhCUXMBTTEEJE5UxaTahiH01KD_BydRE68Q/exec";
    
    // R√©cup√©rer les donn√©es d'un employ√© via JSONP
    function fetchEmployeeData(empId) {
      return new Promise((resolve, reject) => {
        window.handleEmployeeData = function(data) {
          resolve(data);
        };
        const script = document.createElement("script");
        script.src = SHEET_API_URL + "?action=getEmployee&empId=" + encodeURIComponent(empId) + "&callback=handleEmployeeData";
        script.onerror = reject;
        document.body.appendChild(script);
      });
    }
    
    // Nouvelle fonction pour r√©cup√©rer toutes les commandes en "en commande" (pour l'admin)
    function fetchAllOrders() {
      return new Promise((resolve, reject) => {
        window.handleAllOrders = function(data) {
          resolve(data);
        };
        const script = document.createElement("script");
        script.src = SHEET_API_URL + "?action=getAllOrders&callback=handleAllOrders";
        script.onerror = reject;
        document.body.appendChild(script);
      });
    }
    
    // Mise √† jour des donn√©es de l'employ√© vers Google Sheets (pour Equipment, SurplusOrders et ExchangeOrders)
    function updateEmployeeData(empId, equipmentData, surplusData, exchangeData) {
      const payload = {
        action: "updateData",
        empId: empId,
        equipment: equipmentData,
        surplusOrders: surplusData,
        exchangeOrders: exchangeData
      };
      return fetch(SHEET_API_URL, {
        method: "POST",
        mode: "no-cors",
        body: JSON.stringify(payload),
        headers: {"Content-Type": "application/json"}
      }).then(() => ({ status: "success" }));
    }
    
    /*******************************************************
     * Donn√©es simul√©es initiales (pour tests locaux)
     *******************************************************/
    let employees = [
      { 
        id: "emp001", 
        name: "Alice", 
        quota: { pantalon: 2, polo: 3, polaire: 1, casque: 1, veste: 1, lunettes: 1, chaussures: 1, chapeau: 1, adaptateur: 1, habits_pluie: 1 },
        equipment: [],
        surplusOrders: [],
        exchangeOrders: []
      },
      { 
        id: "emp002", 
        name: "Bob", 
        quota: { pantalon: 2, polo: 3, polaire: 1, casque: 1, veste: 1, lunettes: 1, chaussures: 1, chapeau: 1, adaptateur: 1, habits_pluie: 1 },
        equipment: [],
        surplusOrders: [],
        exchangeOrders: []
      },
      { 
        id: "admin", 
        name: "Administrateur", 
        quota: {}, 
        equipment: [],
        surplusOrders: [],
        exchangeOrders: []
      }
    ];
    
    let currentEmployee = null;
    // Panier commun ‚Äì items en mode "shop" ou "exchange"
    let cart = [];
    // Les tarifs en surplus seront charg√©s depuis Google Sheets
    let surplusPrices = {};
    
    // Objet associant chaque produit √† une image (remplacer les URL par de vraies images si n√©cessaire)
    const productImages = {
      pantalon: "https://via.placeholder.com/150?text=Pantalon",
      polo: "https://via.placeholder.com/150?text=Polo",
      polaire: "https://via.placeholder.com/150?text=Polaire",
      casque: "https://via.placeholder.com/150?text=Casque",
      veste: "https://via.placeholder.com/150?text=Veste",
      lunettes: "https://via.placeholder.com/150?text=Lunettes",
      chaussures: "https://via.placeholder.com/150?text=Chaussures",
      chapeau: "https://via.placeholder.com/150?text=Chapeau",
      adaptateur: "https://via.placeholder.com/150?text=Adaptateur",
      habits_pluie: "https://via.placeholder.com/150?text=Habits+Pluie"
    };
    
    // Objet associant chaque produit aux tailles disponibles
    const productSizes = {
      pantalon: ["44", "46", "48", "50", "52", "54", "56", "58", "60", "62"],
      polo: ["S", "M", "L", "XL", "2XL", "3XL", "4XL"],
      polaire: ["S", "M", "L", "XL", "2XL", "3XL", "4XL"],
      veste: ["S", "M", "L", "XL", "2XL", "3XL", "4XL"],
      chaussures: ["40", "41", "42", "43", "44", "45", "46"],
      habits_pluie: ["S", "M", "L", "XL", "2XL", "3XL", "4XL"]
    };
    
    // S'assurer que les tableaux equipment, surplusOrders et exchangeOrders existent dans currentEmployee
    function ensureEmployeeArrays() {
      if (!currentEmployee) return;
      if (!Array.isArray(currentEmployee.equipment)) currentEmployee.equipment = [];
      if (!Array.isArray(currentEmployee.surplusOrders)) currentEmployee.surplusOrders = [];
      if (!Array.isArray(currentEmployee.exchangeOrders)) currentEmployee.exchangeOrders = [];
    }
    
    /*******************************************************
     * Mise √† jour de "Mes √©quipements" (uniquement les commandes quota)
     *******************************************************/
    function updateEquipmentTable() {
      const tbody = document.querySelector("#equipmentTable tbody");
      tbody.innerHTML = "";
      ensureEmployeeArrays();
      if (currentEmployee.equipment.length === 0) {
        let tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="4">Aucun √©quipement command√©.</td>`;
        tbody.appendChild(tr);
      } else {
        let sorted = currentEmployee.equipment.slice().sort((a, b) => a.type.localeCompare(b.type));
        sorted.forEach(item => {
          let tr = document.createElement("tr");
          tr.innerHTML = `<td>${item.type}</td><td>${item.size}</td><td>${item.date}</td><td>${item.status}</td>`;
          tbody.appendChild(tr);
        });
      }
    }
    
    /*******************************************************
     * Affichage du quota poss√©d√© / droit √†
     *******************************************************/
    function updateQuotaInfo() {
      const quotaDiv = document.getElementById("quotaInfo");
      if (!currentEmployee || !currentEmployee.quota) {
        quotaDiv.textContent = "";
        return;
      }
      let html = "<strong>Quota :</strong><br>";
      for (let type in currentEmployee.quota) {
        // Compter uniquement les √©quipements du quota (pas les surplus ni les √©changes en attente)
        let count = currentEmployee.equipment.filter(eq => 
          eq.type === type && (eq.status === "attribu√©" || eq.status === "en commande" || eq.status === "recu")
        ).length;
        html += `${type} : ${count} / ${currentEmployee.quota[type]}<br>`;
      }
      quotaDiv.innerHTML = html;
    }
    
    /*******************************************************
     * Remplissage du menu d'√©change
     *******************************************************/
    function populateExchangeMenu() {
      const exchangeSelect = document.getElementById("exchangeItemSelect");
      exchangeSelect.innerHTML = "";
      ensureEmployeeArrays();
      if (currentEmployee.equipment.length === 0) {
        let opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "Aucun √©quipement disponible";
        exchangeSelect.appendChild(opt);
      } else {
        currentEmployee.equipment.forEach(item => {
          let opt = document.createElement("option");
          opt.value = item.id;
          opt.textContent = `${item.type} (Taille: ${item.size}) ‚Äì Command√© le ${item.date}`;
          exchangeSelect.appendChild(opt);
        });
      }
    }
    
    /*******************************************************
     * Gestion du panier commun
     *******************************************************/
    function updateCartBadge() {
      const cartCount = document.getElementById("cartCount");
      if (cart.length > 0) {
        cartCount.textContent = cart.length;
        cartCount.style.display = "inline";
      } else {
        cartCount.style.display = "none";
      }
    }
    function computeCartStatus() {
      ensureEmployeeArrays();
      let counts = {};
      // Comptabiliser uniquement les √©quipements du quota (excluant le surplus)
      for (let type in currentEmployee.quota) {
        counts[type] = currentEmployee.equipment.filter(eq => 
          eq.type === type && (eq.status === "attribu√©" || eq.status === "en commande" || eq.status === "recu")
        ).length;
      }
      cart.forEach(item => {
        if (item.mode === "shop") {
          let allowed = currentEmployee.quota[item.type] || 0;
          if (counts[item.type] < allowed) {
            item.orderType = "Quota";
            item.price = 0;
            counts[item.type]++;
          } else {
            item.orderType = "Surplus";
            let typeKey = item.type.toString().trim().toLowerCase();
            item.price = surplusPrices[typeKey] || 0;
          }
        }
      });
    }
    function updateCartDisplay() {
      computeCartStatus();
      const tbody = document.querySelector("#cartTable tbody");
      tbody.innerHTML = "";
      if (cart.length === 0) {
        let tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="6">Votre panier est vide.</td>`;
        tbody.appendChild(tr);
      } else {
        cart.forEach((item, index) => {
          let tr = document.createElement("tr");
          let actionBtn = `<button onclick="removeCartItem(${index})" class="close-btn">X</button>`;
          if (item.mode === "shop") {
            let priceDisplay = item.orderType === "Surplus" ? `CHF ${item.price}` : "-";
            tr.innerHTML = `<td>Shop</td><td>${item.type}</td><td>${item.size}</td><td>${item.orderType}</td><td>${priceDisplay}</td><td>${actionBtn}</td>`;
          } else if (item.mode === "exchange") {
            tr.innerHTML = `<td>√âchange</td><td>${item.type}</td><td>${item.size}</td><td>-</td><td>-</td><td>${actionBtn}</td>`;
          }
          tbody.appendChild(tr);
        });
      }
      // Afficher la confirmation de d√©duction de salaire uniquement s'il y a une commande surplus
      if (cart.some(item => item.mode === "shop" && item.orderType === "Surplus")) {
        document.getElementById("surplusConfirmationContainer").style.display = "block";
      } else {
        document.getElementById("surplusConfirmationContainer").style.display = "none";
      }
    }
    function removeCartItem(index) {
      cart.splice(index, 1);
      updateCartBadge();
      updateCartDisplay();
    }
    
    /*******************************************************
     * Affichage de l'historique des commandes en surplus
     *******************************************************/
    function updateSurplusHistory() {
      const tbody = document.querySelector("#surplusHistoryTable tbody");
      tbody.innerHTML = "";
      ensureEmployeeArrays();
      if (currentEmployee.surplusOrders.length === 0) {
        let tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="5">Aucune commande en surplus.</td>`;
        tbody.appendChild(tr);
      } else {
        currentEmployee.surplusOrders.forEach(order => {
          let tr = document.createElement("tr");
          tr.innerHTML = `<td>${order.type}</td><td>${order.size}</td><td>CHF ${order.price}</td><td>${order.date}</td><td>${order.status || "en commande"}</td>`;
          tbody.appendChild(tr);
        });
      }
    }
    
    /*******************************************************
     * D√©connexion
     *******************************************************/
    document.getElementById("logoutBtn").addEventListener("click", function() {
      currentEmployee = null;
      cart = [];
      updateCartBadge();
      document.getElementById("main-section").style.display = "none";
      document.getElementById("logoutBtn").style.display = "none";
      document.getElementById("login-section").style.display = "flex";
      document.getElementById("cartIcon").style.display = "none";
    });
    
    /*******************************************************
     * Connexion avec Google Sheets (GET via JSONP)
     * Affichage du spinner pendant le chargement
     *******************************************************/
    document.getElementById("loginBtn").addEventListener("click", function() {
      const empId = document.getElementById("employeeId").value.trim();
      const loginMessage = document.getElementById("loginMessage");
      document.getElementById("loadingSpinner").style.display = "block";
      fetchEmployeeData(empId)
        .then(data => {
          document.getElementById("loadingSpinner").style.display = "none";
          if(data && data.id) {
            currentEmployee = data;
            if (data.surplusPrices) {
              surplusPrices = data.surplusPrices;
            }
            ensureEmployeeArrays();
            document.getElementById("login-section").style.display = "none";
            document.getElementById("main-section").style.display = "block";
            document.getElementById("logoutBtn").style.display = "block";
            document.getElementById("cartIcon").style.display = "flex";
            document.getElementById("employeeName").textContent = currentEmployee.name;
            updateEquipmentTable();
            populateExchangeMenu();
            updateQuotaInfo();
            if (empId === "admin") {
              document.getElementById("admin-section").style.display = "block";
              updatePendingOrders();
            }
          } else {
            loginMessage.textContent = "Identifiant non trouv√©.";
          }
        })
        .catch(err => {
          document.getElementById("loadingSpinner").style.display = "none";
          console.error(err);
          let localEmp = employees.find(emp => emp.id === empId);
          if(localEmp) {
            currentEmployee = localEmp;
            ensureEmployeeArrays();
            document.getElementById("login-section").style.display = "none";
            document.getElementById("main-section").style.display = "block";
            document.getElementById("logoutBtn").style.display = "block";
            document.getElementById("cartIcon").style.display = "flex";
            document.getElementById("employeeName").textContent = currentEmployee.name;
            updateEquipmentTable();
            populateExchangeMenu();
            updateQuotaInfo();
            if (empId === "admin") {
              document.getElementById("admin-section").style.display = "block";
              updatePendingOrders();
            }
          } else {
            loginMessage.textContent = "Identifiant non trouv√©.";
          }
        });
    });
    
    /*******************************************************
     * Affichage/Masquage des modales et de l'overlay
     *******************************************************/
    function showOverlay() {
      document.getElementById("overlay").classList.add("active");
    }
    function hideOverlay() {
      document.getElementById("overlay").classList.remove("active");
    }
    function showModal(id) {
      document.getElementById(id).classList.add("active");
      showOverlay();
    }
    function hideModal(id) {
      document.getElementById(id).classList.remove("active");
      hideOverlay();
    }
    // Popup Shop ‚Äì ouverture via boutique en ligne
    document.getElementById("openShopBtn").addEventListener("click", function() {
      populateShopModal();
      showModal("shopModal");
    });
    document.getElementById("closeShopModal").addEventListener("click", function() {
      hideModal("shopModal");
    });
    // Popup √âchange
    document.getElementById("openExchangeBtn").addEventListener("click", function() {
      populateExchangeMenu();
      showModal("exchangeModal");
    });
    document.getElementById("closeExchangeModal").addEventListener("click", function() {
      hideModal("exchangeModal");
    });
    // Popup Historique Surplus
    document.getElementById("openSurplusHistoryBtn").addEventListener("click", function() {
      updateSurplusHistory();
      showModal("surplusHistoryModal");
    });
    document.getElementById("closeSurplusHistoryModal").addEventListener("click", function() {
      hideModal("surplusHistoryModal");
    });
    // Popup Panier via l'ic√¥ne du panier
    document.getElementById("cartIcon").addEventListener("click", function() {
      updateCartDisplay();
      showModal("cartModal");
    });
    document.getElementById("closeCartModal").addEventListener("click", function() {
      hideModal("cartModal");
    });
    
    /*******************************************************
     * Fonction de cr√©ation des cartes produits pour le Shop
     *******************************************************/
    function populateShopModal() {
      const container = document.getElementById("shopProductsContainer");
      container.innerHTML = "";
      // Pour chaque type d'article d√©fini dans le quota de l'employ√©
      for (let type in currentEmployee.quota) {
         let card = document.createElement("div");
         card.className = "product-card";
         // Image du produit
         let img = document.createElement("img");
         img.src = productImages[type] || ("https://via.placeholder.com/150?text=" + type);
         card.appendChild(img);
         // Nom du produit
         let title = document.createElement("h4");
         title.textContent = type;
         card.appendChild(title);
         // S√©lecteur de taille
         let select = document.createElement("select");
         select.id = "shopSize_" + type;
         if (["casque", "chapeau", "adaptateur", "lunettes"].includes(type)) {
           let opt = document.createElement("option");
           opt.value = "N/A";
           opt.textContent = "N/A";
           select.appendChild(opt);
         } else if (["pantalon", "polo", "polaire", "veste", "chaussures", "habits_pluie"].includes(type)) {
           let sizes = productSizes[type];
           sizes.forEach(size => {
             let opt = document.createElement("option");
             opt.value = size;
             opt.textContent = size;
             select.appendChild(opt);
           });
         } else {
           let opt = document.createElement("option");
           opt.value = "";
           opt.textContent = "Non applicable";
           select.appendChild(opt);
         }
         card.appendChild(select);
         // Bouton Ajouter au panier
         let btn = document.createElement("button");
         btn.className = "btn";
         btn.textContent = "Ajouter au panier";
         btn.addEventListener("click", function() {
           addToCartShop(type);
         });
         card.appendChild(btn);
         container.appendChild(card);
      }
    }
    
    function addToCartShop(type) {
      const select = document.getElementById("shopSize_" + type);
      let size = select ? select.value : "";
      cart.push({ mode: "shop", type: type, size: size });
      updateCartBadge();
      hideModal("shopModal");
    }
    
    /*******************************************************
     * Bouton "Ajouter au panier" dans le popup √âchange
     *******************************************************/
    document.getElementById("addToExchangeCartBtn").addEventListener("click", function() {
      const selectedId = document.getElementById("exchangeItemSelect").value;
      const eq = currentEmployee.equipment.find(item => item.id === selectedId);
      if (!eq) return;
      cart.push({ mode: "exchange", equipmentId: eq.id, type: eq.type, size: eq.size });
      updateCartBadge();
      hideModal("exchangeModal");
    });
    
    /*******************************************************
     * Confirmation du panier (checkout)
     * La confirmation de surplus s'affiche uniquement pour les commandes en surplus.
     *******************************************************/
    document.getElementById("confirmCartBtn").addEventListener("click", function() {
      computeCartStatus();
      let hasSurplus = cart.some(item => item.mode === "shop" && item.orderType === "Surplus");
      if (hasSurplus) {
        if (!document.getElementById("surplusConfirmCheckbox").checked) {
          document.getElementById("cartMessage").textContent = "Veuillez confirmer votre commande en surplus et accepter la d√©duction de salaires.";
          return;
        }
      }
      const dateNow = new Date().toLocaleString();
      ensureEmployeeArrays();
      cart.forEach(item => {
        if (item.mode === "shop") {
          if (item.orderType === "Quota") {
            currentEmployee.equipment.push({
              id: generateId(),
              type: item.type,
              size: item.size,
              date: dateNow,
              status: "en commande",
              orderType: "Quota"
            });
          } else if (item.orderType === "Surplus") {
            currentEmployee.surplusOrders.push({
              id: generateId(),
              type: item.type,
              size: item.size,
              price: item.price,
              date: dateNow,
              status: "en commande",
              orderType: "Surplus"
            });
          }
        } else if (item.mode === "exchange") {
          // Pour une commande d'√©change, on l'enregistre dans exchangeOrders pour validation admin
          currentEmployee.exchangeOrders.push({
              id: generateId(),
              type: item.type,
              size: item.size,
              equipmentId: item.equipmentId,
              date: dateNow,
              status: "en commande",
              orderType: "Exchange"
          });
        }
      });
      document.getElementById("cartMessage").textContent = "Commande trait√©e avec succ√®s.";
      updateEmployeeData(currentEmployee.id, currentEmployee.equipment, currentEmployee.surplusOrders, currentEmployee.exchangeOrders)
        .then(result => console.log("Mise √† jour r√©ussie :", result))
        .catch(err => console.error(err));
      cart = [];
      updateCartBadge();
      updateEquipmentTable();
      updateQuotaInfo();
      document.getElementById("surplusConfirmCheckbox").checked = false;
      setTimeout(function() {
        hideModal("cartModal");
        document.getElementById("cartMessage").textContent = "";
      }, 1500);
    });
    
    /*******************************************************
     * G√©n√©ration d'un ID unique
     *******************************************************/
    function generateId() {
      return 'eq-' + Date.now() + '-' + Math.floor(Math.random() * 1000);
    }
    
    /*******************************************************
     * Interface Administrateur : Mise √† jour des commandes en cours
     * Combine les commandes du quota, les surplus et les √©changes
     *******************************************************/
    function updatePendingOrders() {
      fetchAllOrders().then(orders => {
        const tbody = document.querySelector("#pendingOrdersTable tbody");
        tbody.innerHTML = "";
        if (orders.length === 0) {
          let tr = document.createElement("tr");
          tr.innerHTML = `<td colspan="6">Aucune commande en cours.</td>`;
          tbody.appendChild(tr);
        } else {
          orders.forEach(order => {
            // R√©cup√©rer le nom de l'employ√© depuis le tableau simul√© (si disponible)
            let emp = employees.find(e => e.id === order.empId);
            let empName = emp ? emp.name : order.empId;
            let tr = document.createElement("tr");
            tr.innerHTML = `<td>${empName}</td><td>${order.type}</td><td>${order.size}</td><td>${order.date}</td><td>${order.orderType || "Quota"}</td>
              <td><button class="btn" onclick="validateOrder('${order.empId}','${order.id}','${order.orderType || "Quota"}')">Valider</button></td>`;
            tbody.appendChild(tr);
          });
        }
      }).catch(err => console.error(err));
    }
    
    // Fonction de validation d'une commande (admin)
    function validateOrder(empId, orderId, orderType) {
      document.getElementById("adminSpinner").style.display = "block";
      fetchEmployeeData(empId)
        .then(data => {
          if(orderType === "Quota") {
            let equipment = data.equipment;
            let order = equipment.find(item => item.id === orderId);
            if(order && order.status === "en commande") {
              order.status = "recu";
            }
            updateEmployeeData(empId, equipment, data.surplusOrders, data.exchangeOrders)
              .then(result => {
                console.log("Commande valid√©e :", result);
                updatePendingOrders();
                document.getElementById("adminSpinner").style.display = "none";
              });
          } else if (orderType === "Surplus") {
            let surplusOrders = data.surplusOrders || [];
            let order = surplusOrders.find(item => item.id === orderId);
            if(order && order.status === "en commande") {
              order.status = "recu";
            }
            updateEmployeeData(empId, data.equipment, surplusOrders, data.exchangeOrders)
              .then(result => {
                console.log("Commande valid√©e :", result);
                updatePendingOrders();
                document.getElementById("adminSpinner").style.display = "none";
              });
          } else if (orderType === "Exchange") {
            let exchangeOrders = data.exchangeOrders || [];
            let order = exchangeOrders.find(item => item.id === orderId);
            if(order && order.status === "en commande") {
              order.status = "recu";
              // Supprimer l'article correspondant de la liste d'√©quipements
              data.equipment = data.equipment.filter(eq => eq.id !== order.equipmentId);
            }
            updateEmployeeData(empId, data.equipment, data.surplusOrders, exchangeOrders)
              .then(result => {
                console.log("Commande d'√©change valid√©e :", result);
                updatePendingOrders();
                document.getElementById("adminSpinner").style.display = "none";
              });
          }
        })
        .catch(err => {
          console.error(err);
          document.getElementById("adminSpinner").style.display = "none";
        });
    }
  </script>
</body>
</html>